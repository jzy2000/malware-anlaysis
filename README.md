# Analyze a malware sample
This is a 16-bit Windows malware sample being analyzed using common procedure:
 -  Setup VM analysis environment and tooling
 -  Unpack the binary
 -  Monitor binary dynamic behavior with various running conditions
 -  Patch binary to satisfy running conditions
 -  Reverse the binary and analyze specific area of interest
 -  Collect artifacts during the analysis 

# Highlights
Interesting findings include but are not limited to:
 - Use of known packer 
 - Password protected executin path, after patched:
 <img src="https://github.com/jzy2000/malware-anlaysis/blob/master/images/bypass-check.png" align="reverse jnz" height="48" width="48">

 - Anti-debugger technique#1: IsDebugPresent() check presence of user-mode debugger(stored in PEB::IsDebugged field), this condition leads to TerminateProcess(): 
 <img src="https://github.com/jzy2000/malware-anlaysis/blob/master/images/isdebugpresent.png" align="isdebugpresent" height="48" width="48">

- Anti-debugger technique#2: GetProcAddress()+EncodePointer()+DecodePointer() obfuscates imported function calls using per-process secret, such as GetTickCount():
 <img src="https://github.com/jzy2000/malware-anlaysis/blob/master/images/GetProcAddress.png" align="GetProcAddress" height="48" width="48"><img src="https://github.com/jzy2000/malware-anlaysis/blob/master/images/EncodePointer.png" align="EncodePointer" height="48" width="48">
 
 - Anti-debugger technique#3: IsProcessorFeaturePresent(17h) checks __fastfail support before proceeding with immediate termination:
 <img src="https://github.com/jzy2000/malware-anlaysis/blob/master/images/IsProcessorFeaturePresent.png" align="IsProcessorFeaturePresent" height="48" width="48">
 
 - Anti-debugger technique#4: IsProcessorFeaturePresent(0Ah) checks SSE instruction set available and collect CPU ID info:
 <img src="https://github.com/jzy2000/malware-anlaysis/blob/master/images/Cupid.png" align="Cupid" height="48" width="48">
 
 - Anti-debugger technique#5: SetUnhandledExceptionFilter() + UnhandledExceptionFilter() check presence of debugger by replacing top-level exception handler for all threads. If executable is being debugged, then the custom handler will not be called, result in malware terminates the process:
 <img src="https://github.com/jzy2000/malware-anlaysis/blob/master/images/SetUnhandledExceptionFilter.png" align="SetUnhandledExceptionFilter" height="48" width="48">
 
 - Anti-debugger technique#6: SetLastError(code)+OutputDebugString() + GetLastError() check error code remaining condition to confirm debugger free:
 <img src="https://github.com/jzy2000/malware-anlaysis/blob/master/images/IsDebuggerPresent.png" align="IsDebuggerPresent" height="48" width="48">
 
 - Anti-debugger technique#7: Read PEB::BeingDebugged flag:
 <img src="https://github.com/jzy2000/malware-anlaysis/blob/master/images/BeingDebugged.png" align="BeingDebugged" height="48" width="48"><img src="https://github.com/jzy2000/malware-anlaysis/blob/master/images/BeingDebugged2.png" align="BeingDebugged2" height="48" width="48">
 
 - Anti-debugging exit flow:
 <img src="https://github.com/jzy2000/malware-anlaysis/blob/master/images/Fishnet.png" align="Fishnet" height="48" width="48">
 
 - Malicious processes and dependencies:
 <img src="https://github.com/jzy2000/malware-anlaysis/blob/master/images/RegKeyCreate.png" align="Process tree" height="48" width="48">
 
 - Malicious COM scriptlet key and content: 
 <img src="https://github.com/jzy2000/malware-anlaysis/blob/master/images/ScriptletURL.png" align="ScriptletURL" height="48" width="48"><img src="https://github.com/jzy2000/malware-anlaysis/blob/master/images/VBScript.png" align="VBScript" height="48" width="48">
 
 - Trojan get downloaded by Scriptlet using Msxml2.Server XMLHTTP, writes into C:\Users\admin\AppData\Local\Temp\
 <img src="https://github.com/jzy2000/malware-anlaysis/blob/master/images/.png" align="" height="48" width="48">
 
 - Malicious IPs observed:
 
   - amp-tg-ret.s3.amazonaws.com 52.216.16.168
   - www.allyourbasearebelongtous.com  75.119.198.176
   - 52.216.130.187:80 (certutil.exe) US
   - 92.122.18.115:443 (ie.exe) EU
   - 93.184.220.29:80 (ie.exe) EU
   - 2.22.146.113:80 (ie.exe) EU
   - 104.18.25.243:80 (ie.exe) US
   - 152.199.19.160:80 (ie.exe) US
